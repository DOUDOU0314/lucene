# 说明

本文提出一种复用全文检索技术的数值类区间查询方案，即基于词典的方案。

# 词典

词典是全文检索里面的概念，可以类比成Trie树，词典有一个功能就是将字符串映射成整型的ID，词典中字符串的大小关系和映射成的ID之间的大小关系是一致的。

# 数值类型->字符串
数值类型数据可以转换成字符串类型，并且任意数值之间的大小关系和转换而得的字符串之间的大小关系是一致的，具体转换方法可以参考：[lucene数值区间查询原理](https://github.com/zzboy/lucene/blob/master/lucene%E6%95%B0%E5%80%BC%E5%8C%BA%E9%97%B4%E6%9F%A5%E8%AF%A2%E5%8E%9F%E7%90%86.md)

# 数值类型->ID
将数值类型转换成字符串，使用该字符串构建词典，这样对于每个数值都能得到一个ID，并且数值之间的大小关系和ID之间的大小关系是一致的，另外ID是连续的。

# 倒排表
文本索引技术中，针对分词而得的每个term和该文档的序号关联，这样当文档集处理完后，每个term都会关联一个文档集合，这个文档集合就称为倒排表。

我们将词典中的每个词的倒排表拼接起来，并记录每个ID其倒排表在拼接后的list中的偏移，这样在查询一个数值的时候，首先将数值处理成字符串，再通过词典获得ID，接着根据ID拿到偏移，再用后一个ID的偏移就能够拿到长度，这样就很容易读出来该数值关联的倒排表。
# 优化
1. ID其实是一个帮助理解的概念，实际上可以在词典中直接存储词在doclist中的偏移。
2. 将doc list分块存储，比如4096个doc一个block，这样在数值区间查询的时候，就可以只读关联的doc block，而不需要整个读出doc list，同样是一次读盘，数据量可能会小很多。
# 总结
1.优点
复用全文索引的词典技术，只是改动了倒排表的存储方式，如果已经有词典功能，开发代价很小，上线很快。

2.缺点
* 数值要转换成文本，构建词典时要字符串比较，这样对写入性能会有影响。
* 词典必须实现很复杂，否则需要将词典整个加载到内存才能查询，这样load了大量无关数据，没有必要。

目前调研下来Block K-D tree是更好的方案。
